<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω C√¥ng tr√¨nh</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Light/Dark Mode CSS Variables --- */
        :root {
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --primary-navy: #2c3e50;
            --primary-navy-dark: #1a2530;
            --accent-blue: #3498db;
            --success-teal: #2ecc71;
            --danger-rose: #e74c3c;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 20px rgba(0,0,0,0.08);
        }

        .dark-mode {
            --bg-body: #121826;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --primary-navy: #3b82f6;
            --primary-navy-dark: #2563eb;
            --accent-blue: #60a5fa;
            --success-teal: #34d399;
            --danger-rose: #f87171;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.25);
            --shadow-lg: 0 8px 20px rgba(0,0,0,0.3);
        }

        /* --- General Styles --- */
        .hidden { display: none !important; }
        body {
            margin: 0;
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            padding: 20px;
            padding-bottom: 100px;
            max-width: 800px;
            margin: 0 auto;
        }
        .page-header {
            font-size: 32px;
            font-weight: 700;
            margin: 0 0 28px 0;
            display: flex;
            align-items: center;
            color: var(--primary-navy);
        }
        .welcome-header {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        .back-button, .hamburger-btn {
            background: none;
            border: none;
            font-size: 28px;
            margin-right: 12px;
            cursor: pointer;
            color: var(--primary-navy);
        }
        .status-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 50px 0;
        }
        .text-green { color: var(--success-teal); }
        .text-red { color: var(--danger-rose); }

        /* --- Animations --- */
        .view {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Views --- */
        .view.active { display: block; }
        .view { display: none; }

        /* --- Overview View --- */
        .overview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .stat-card {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: 14px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        .stat-card .label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
        }
        .stat-card.full-width { grid-column: 1 / -1; }
        @media (max-width: 600px) {
            .overview-grid { grid-template-columns: 1fr; }
        }

        /* --- Project List View --- */
        .create-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 18px;
            margin-bottom: 28px;
            font-size: 18px;
            font-weight: 700;
            color: var(--bg-card);
            background: linear-gradient(to right, var(--primary-navy), var(--accent-blue));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
        }
        .create-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        .project-card {
            background-color: var(--bg-card);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            position: relative;
            margin-bottom: 24px;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        .project-card h2 {
            margin: 0 0 8px 0;
            font-size: 22px;
            font-weight: 700;
            padding-right: 30px;
            color: var(--primary-navy);
        }
        .project-card .description {
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-size: 15px;
        }
        .project-card .info-item {
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-size: 15px;
            display: flex;
            align-items: center;
        }
        .project-card .info-item .icon {
            margin-right: 8px;
            font-size: 18px;
        }
        .project-card .details-button {
            width: 100%;
            padding: 14px;
            margin-top: 16px;
            border: none;
            background-color: var(--primary-navy);
            color: var(--bg-card);
            border-radius: 10px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .project-card .details-button:hover {
            background-color: var(--primary-navy-dark);
        }
        .project-card .delete-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--danger-rose);
            font-size: 22px;
            z-index: 2;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .project-card .delete-button:hover {
            opacity: 1;
        }
        .project-owner {
            font-size: 12px;
            background-color: #e8f4f8;
            color: var(--accent-blue);
            padding: 4px 10px;
            border-radius: 99px;
            font-weight: 500;
            margin-top: 16px;
            display: inline-block;
        }
        .dark-mode .project-owner {
            background-color: #1e3a5f;
        }

        /* --- Search Section --- */
        .search-section {
            margin-top: 40px;
            background-color: var(--bg-card);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        .search-section h2 {
            margin-top: 0;
            color: var(--primary-navy);
        }
        .search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-item:hover {
            background-color: #f1f8fb;
        }
        .dark-mode .search-result-item:hover {
            background-color: #334155;
        }
        .search-result-item .info .project-name {
            font-size: 12px;
            color: var(--accent-blue);
            font-weight: 500;
            margin-top: 4px;
        }

        /* --- Project Detail View --- */
        .finance-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        .finance-card {
            background: var(--bg-card);
            padding: 18px;
            border-radius: 14px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        .finance-card .label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .finance-card .value {
            font-weight: 700;
            font-size: 16px;
        }
        .finance-balance-card {
            grid-column: 1 / -1;
            margin-bottom: 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            background: var(--bg-card);
            border-radius: 14px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        .finance-balance-card .label {
            font-size: 14px;
            margin-bottom: 0;
            font-weight: 600;
        }
        .finance-balance-card .value {
            font-size: 18px;
            font-weight: 700;
        }
        .transaction-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        .tab-btn {
            flex: 1;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .tab-btn.active {
            color: var(--primary-navy);
            border-bottom: 3px solid var(--primary-navy);
        }
        .add-transaction-form {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 28px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        .form-row {
            margin-bottom: 16px;
        }
        .form-input {
            padding: 16px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            font-family: inherit;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .add-btn {
            background-color: var(--primary-navy);
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        .add-btn:hover {
            background-color: var(--primary-navy-dark);
        }
        .transaction-list h3 {
            margin-bottom: 16px;
            font-size: 20px;
            color: var(--primary-navy);
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 18px;
            border-bottom: 1px solid var(--border-color);
        }
        .transaction-item:first-of-type {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .transaction-item:last-of-type {
            border-bottom: none;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        .t-info .t-desc {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 16px;
        }
        .t-info .t-date {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .t-amount {
            font-weight: 700;
            font-size: 16px;
        }

        /* --- Edit/Delete Buttons --- */
        .edit-btn, .delete-tx-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin-left: 8px;
        }
        .edit-btn {
            background-color: #e8f4f8;
            color: var(--accent-blue);
        }
        .dark-mode .edit-btn {
            background-color: #1e3a5f;
        }
        .edit-btn:hover {
            background-color: #d1eaf4;
        }
        .dark-mode .edit-btn:hover {
            background-color: #2a4a75;
        }
        .delete-tx-btn {
            background-color: #fdf2f2;
            color: var(--danger-rose);
        }
        .dark-mode .delete-tx-btn {
            background-color: #4a1f1f;
        }
        .delete-tx-btn:hover {
            background-color: #f8d6d6;
        }
        .dark-mode .delete-tx-btn:hover {
            background-color: #6a2a2a;
        }

        /* --- Export Section --- */
        .export-section {
            background-color: var(--bg-card);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            margin-top: 24px;
            border: 1px solid var(--border-color);
        }
        .export-section h3 {
            margin-top: 0;
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--primary-navy);
        }
        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        .export-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s;
        }
        .btn-pdf {
            background-color: var(--danger-rose);
            color: white;
        }
        .btn-pdf:hover {
            background-color: #c0392b;
        }
        .dark-mode .btn-pdf:hover {
            background-color: #b91c1c;
        }
        .btn-excel {
            background-color: var(--success-teal);
            color: white;
        }
        .btn-excel:hover {
            background-color: #27ae60;
        }
        .dark-mode .btn-excel:hover {
            background-color: #16a34a;
        }
        .btn-email {
            background-color: var(--accent-blue);
            color: white;
            grid-column: 1 / -1;
        }
        .btn-email:hover {
            background-color: #2980b9;
        }
        .dark-mode .btn-email:hover {
            background-color: #3b82f6;
        }

        /* --- Admin View --- */
        .admin-section h2 {
            font-size: 22px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 16px;
            color: var(--primary-navy);
        }
        .user-card {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-card);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            gap: 12px;
            border: 1px solid var(--border-color);
        }
        .user-details {
            flex: 1 1 200px;
        }
        .user-details .display-name {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-navy);
        }
        .user-details .email {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .user-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .btn-set-name {
            background-color: #e8f4f8;
            color: var(--accent-blue);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .dark-mode .btn-set-name {
            background-color: #1e3a5f;
        }
        .btn-set-name:hover {
            background-color: #d1eaf4;
        }
        .dark-mode .btn-set-name:hover {
            background-color: #2a4a75;
        }
        .permission-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .permission-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
        }
        .permission-toggle {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .permission-toggle .toggle-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--success-teal);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        .dark-mode .slider {
            background-color: #4b5563;
        }
        .dark-mode .slider:before {
            background-color: #e5e7eb;
        }

        /* --- Modals, Navs, Side Panel --- */
        .modal-backdrop, .side-panel-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            animation: fadeIn 0.3s;
        }
        .modal-backdrop {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 28px;
            width: 90%;
            max-width: 450px;
            z-index: 101;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .modal h2 {
            margin-top: 0;
            font-size: 24px;
            color: var(--primary-navy);
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }
        .modal button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
        }
        .btn-save {
            background-color: var(--primary-navy);
            color: #fff;
        }
        .btn-save:hover {
            background-color: var(--primary-navy-dark);
        }
        .btn-cancel {
            background-color: #e9ecef;
        }
        .dark-mode .btn-cancel {
            background-color: #334155;
            color: #f1f5f9;
        }
        .btn-cancel:hover {
            background-color: #dee2e6;
        }
        .dark-mode .btn-cancel:hover {
            background-color: #475569;
        }
        .side-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            max-width: 300px;
            height: 100%;
            background-color: var(--bg-card);
            z-index: 110;
            box-shadow: var(--shadow-lg);
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            border-right: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .side-panel.open {
            transform: translateX(0);
        }
        .side-panel-header {
            padding: 20px;
            font-size: 20px;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-navy);
        }
        .side-panel-list a {
            display: block;
            padding: 16px 20px;
            text-decoration: none;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }
        .side-panel-list a:hover {
            background-color: #f1f8fb;
        }
        .dark-mode .side-panel-list a:hover {
            background-color: #334155;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 75px;
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08);
            z-index: 90;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0 10px;
            transition: color 0.2s;
        }
        .nav-item .icon {
            font-size: 28px;
            margin-bottom: 4px;
        }
        .nav-item.active {
            color: var(--primary-navy);
        }
        .theme-toggle {
            font-size: 24px;
        }
    </style>
</head>
<body>
    <main class="container">
        <div id="welcome-message" class="welcome-header"></div>
        <!-- VIEW 1: OVERVIEW -->
        <div id="overview-view" class="view">
            <h1 class="page-header">T·ªïng quan</h1>
            <div id="overview-container" class="overview-grid">
                <p class="status-message full-width">ƒêang t·∫£i d·ªØ li·ªáu t·ªïng quan...</p>
            </div>
        </div>
        <!-- VIEW 2: PROJECTS LIST -->
        <div id="projects-view" class="view active">
            <h1 class="page-header">C√¥ng tr√¨nh</h1>
            <button class="create-button" id="show-modal-btn"><span class="plus-icon">+</span> T·∫°o c√¥ng tr√¨nh m·ªõi</button>
            <div id="projects-container"><p class="status-message">ƒêang t·∫£i...</p></div>
            <!-- SEARCH SECTION -->
            <div class="search-section">
                <h2>T√¨m ki·∫øm Giao d·ªãch</h2>
                <input type="search" id="transaction-search-input" class="form-input" placeholder="Nh·∫≠p m√¥ t·∫£ ƒë·ªÉ t√¨m...">
                <div id="search-results-container">
                    <p class="status-message">Li√™n h·ªá ng∆∞·ªùi l√†m ra app ƒë·ªÉ ƒëƒÉng k√Ω t√†i kho·∫£n (BTA)</p>
                </div>
            </div>
        </div>
        <!-- VIEW 3: PROJECT DETAIL (THU/CHI) -->
        <div id="project-detail-view" class="view">
            <header class="page-header">
                <button class="hamburger-btn" onclick="toggleSidePanel()">‚ò∞</button>
                <button class="back-button" onclick="goBackToProjects()">‚Üê</button>
                <span id="detail-project-name">T√™n c√¥ng tr√¨nh</span>
            </header>
             <div class="finance-summary">
                <div class="finance-card"><div class="label">T·ªïng Thu</div><div class="value text-green" id="sum-thu">0 ƒë</div></div>
                <div class="finance-card"><div class="label">T·ªïng Chi</div><div class="value text-red" id="sum-chi">0 ƒë</div></div>
            </div>
            <div class="finance-card finance-balance-card">
                <div class="label">S·ªë d∆∞</div>
                <div class="value" id="sum-balance">0 ƒë</div>
            </div>
            <div class="transaction-tabs">
                <button class="tab-btn active" onclick="switchTransactionTab('thu', this)">Th√™m Kho·∫£n Thu</button>
                <button class="tab-btn" onclick="switchTransactionTab('chi', this)">Th√™m Kho·∫£n Chi</button>
            </div>
            <div id="thu-form-container" class="add-transaction-form">
                <form id="transaction-form-thu">
                    <div class="form-row"><input type="text" id="t-amount-thu" class="form-input" placeholder="S·ªë ti·ªÅn Thu (VNƒê)" required oninput="formatInputMoney(this)"></div>
                    <div class="form-row"><input type="text" id="t-desc-thu" class="form-input" placeholder="M√¥ t·∫£ (VD: Ch·ªß nh√† ·ª©ng ti·ªÅn)" required></div>
                    <button type="submit" class="add-btn">Th√™m Kho·∫£n Thu</button>
                    <button type="button" class="btn-cancel" id="cancel-edit-thu-btn" style="margin-top:8px;display:none;width:100%;padding:12px;background:#e9ecef;border:none;border-radius:8px;cursor:pointer;font-weight:500;" onclick="cancelEditTransaction('thu')">H·ªßy s·ª≠a</button>
                </form>
            </div>
            <div id="chi-form-container" class="add-transaction-form hidden">
                 <form id="transaction-form-chi">
                    <div class="form-row"><input type="text" id="t-amount-chi" class="form-input" placeholder="S·ªë ti·ªÅn Chi (VNƒê)" required oninput="formatInputMoney(this)"></div>
                    <div class="form-row"><input type="text" id="t-desc-chi" class="form-input" placeholder="M√¥ t·∫£ (VD: Mua v·∫≠t t∆∞, Tr·∫£ l∆∞∆°ng)" required></div>
                    <button type="submit" class="add-btn">Th√™m Kho·∫£n Chi</button>
                    <button type="button" class="btn-cancel" id="cancel-edit-chi-btn" style="margin-top:8px;display:none;width:100%;padding:12px;background:#e9ecef;border:none;border-radius:8px;cursor:pointer;font-weight:500;" onclick="cancelEditTransaction('chi')">H·ªßy s·ª≠a</button>
                </form>
            </div>
            <div class="transaction-list">
                <h3>L·ªãch s·ª≠ giao d·ªãch</h3>
                <div id="transactions-container"><p class="status-message">Ch∆∞a c√≥ giao d·ªãch n√†o.</p></div>
            </div>
        </div>
        <!-- VIEW 4: ADMIN -->
        <div id="admin-view" class="view">
            <h1 class="page-header">Qu·∫£n tr·ªã vi√™n</h1>
            <button class="create-button" onclick="window.location.href='admin-register.html'" style="margin-bottom:20px;">+ ƒêƒÉng k√Ω User M·ªõi</button>
            <div class="admin-section">
                <h2>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
                <div id="users-container"><p class="status-message">ƒêang t·∫£i...</p></div>
            </div>
        </div>
    </main>
    <!-- CREATE PROJECT MODAL -->
    <div id="create-project-modal" class="modal-backdrop hidden">
        <div class="modal">
            <h2>C√¥ng tr√¨nh m·ªõi</h2>
            <form id="project-form">
                <div class="form-group"><label>T√™n c√¥ng tr√¨nh *</label><input type="text" id="p-name" required></div>
                <div class="form-group"><label>M√¥ t·∫£</label><textarea id="p-desc" rows="2"></textarea></div>
                <div class="form-group"><label>ƒê·ªãa ch·ªâ</label><input type="text" id="p-address"></div>
                <div class="form-group"><label>Ng√¢n s√°ch d·ª± ki·∫øn *</label><input type="text" id="p-budget" required oninput="formatInputMoney(this)"></div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="cancel-p-btn">H·ªßy</button>
                    <button type="submit" class="btn-save">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
    <!-- HAMBURGER SIDE PANEL -->
    <div id="side-panel-backdrop" class="side-panel-backdrop hidden" onclick="toggleSidePanel()"></div>
    <div id="project-side-panel" class="side-panel">
        <div class="side-panel-header">Chuy·ªÉn c√¥ng tr√¨nh</div>
        <div id="side-panel-project-list" class="side-panel-list"></div>
    </div>
    <nav class="bottom-nav" id="main-nav">
        <button class="nav-item" data-view="overview-view"><span class="icon">üè†</span><span>T·ªïng quan</span></button>
        <button class="nav-item active" data-view="projects-view"><span class="icon">üìã</span><span>C√¥ng tr√¨nh</span></button>
        <button class="nav-item hidden" id="admin-nav-btn" data-view="admin-view"><span class="icon">üõ°Ô∏è</span><span>Admin</span></button>
        <button class="nav-item" id="theme-toggle-btn" onclick="toggleTheme()"><span class="icon theme-toggle">üåì</span><span>Giao di·ªán</span></button>
        <button class="nav-item" id="logout-btn"><span class="icon">üö™</span><span>ƒêƒÉng xu·∫•t</span></button>
    </nav>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // --- Theme Toggle ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // --- CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyBKfEhKahWesUl_JV6mlSWmaKW2LSkKqos",
            authDomain: "quanlycongtrinh-ab20c.firebaseapp.com",
            projectId: "quanlycongtrinh-ab20c",
            storageBucket: "quanlycongtrinh-ab20c.firebasestorage.app",
            messagingSenderId: "465625666899",
            appId: "1:465625666899:web:e67ccdfdbc9dc85ad7fda6"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let currentProjectId = null;
        let currentProjectData = null;
        let editingTransactionId = null;

        // Initialize theme on load
        window.addEventListener('DOMContentLoaded', initTheme);

        // --- AUTH STATE LISTENER ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.uid).get();
                currentUser = userDoc.exists ? { uid: user.uid, ...userDoc.data() } : { 
                    uid: user.uid, 
                    email: user.email, 
                    role: 'user', 
                    canManageProjects: false,
                    canManageTransactions: false 
                };
                document.getElementById('welcome-message').textContent = `Xin ch√†o, ${currentUser.displayName || currentUser.email}!`;
                document.getElementById('admin-nav-btn').classList.toggle('hidden', currentUser.role !== 'admin');
                const createBtn = document.getElementById('show-modal-btn');
                const canCreate = currentUser.role === 'admin' || currentUser.canManageProjects;
                createBtn.classList.toggle('hidden', !canCreate);
                document.querySelector('.nav-item[data-view="projects-view"]').click();
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- NAVIGATION LOGIC ---
        const navItems = document.querySelectorAll('.nav-item[data-view]');
        const views = document.querySelectorAll('.view');
        const bottomNav = document.getElementById('main-nav');
        function switchView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            bottomNav.classList.toggle('hidden', viewId === 'project-detail-view');
            if (viewId !== 'project-detail-view') {
                navItems.forEach(nav => nav.classList.toggle('active', nav.getAttribute('data-view') === viewId));
            }
        }
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const viewId = item.getAttribute('data-view');
                switchView(viewId);
                if (viewId === 'overview-view') fetchOverviewData();
                if (viewId === 'projects-view') fetchProjects();
                if (viewId === 'admin-view') loadAdminUsers();
            });
        });
        function goBackToProjects() {
            currentProjectId = null;
            currentProjectData = null;
            editingTransactionId = null;
            switchView('projects-view');
            fetchProjects();
        }

        // --- UTILS ---
        const formatMoney = (num) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num);
        function formatInputMoney(input) {
            let value = input.value.replace(/\D/g, '');
            input.value = value ? new Intl.NumberFormat('vi-VN').format(value) : '';
        }
        function parseRawMoney(formattedValue) { return parseInt(String(formattedValue).replace(/\D/g, '')) || 0; }
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'Kh√¥ng c√≥ ng√†y';
            const date = timestamp.toDate();
            return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        };
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        };

        // --- CHECK PERMISSIONS ---
        function canUserManageProjects() {
            return currentUser.role === 'admin' || currentUser.canManageProjects === true;
        }
        function canUserManageTransactions() {
            return currentUser.role === 'admin' || currentUser.canManageTransactions === true;
        }
        function canUserManageThisProject(projectOwnerId) {
            return currentUser.role === 'admin' || 
                   (projectOwnerId === currentUser.uid && currentUser.canManageProjects === true);
        }

        // --- OVERVIEW FUNCTIONS ---
        async function fetchOverviewData() {
            const container = document.getElementById('overview-container');
            container.innerHTML = `<p class="status-message full-width">ƒêang t·∫£i d·ªØ li·ªáu...</p>`;
            try {
                let projectQuery = db.collection('projects');
                if (currentUser.role !== 'admin') {
                    projectQuery = projectQuery.where('owner', '==', currentUser.uid);
                }
                const projectSnap = await projectQuery.get();
                let totalProjects = 0, totalBudget = 0, totalThu = 0, totalChi = 0;
                let todayThu = 0, todayChi = 0, monthThu = 0, monthChi = 0;
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const monthStart = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);
                for (const doc of projectSnap.docs) {
                    totalProjects++;
                    totalBudget += doc.data().budget || 0;
                    const txSnap = await db.collection('projects').doc(doc.id).collection('transactions').get();
                    txSnap.forEach(txDoc => {
                        const tx = txDoc.data();
                        const txDate = tx.createdAt ? tx.createdAt.toDate() : new Date();
                        if (tx.type === 'thu') {
                            totalThu += tx.amount;
                            if (txDate >= todayStart) todayThu += tx.amount;
                            if (txDate >= monthStart) monthThu += tx.amount;
                        } else {
                            totalChi += tx.amount;
                            if (txDate >= todayStart) todayChi += tx.amount;
                            if (txDate >= monthStart) monthChi += tx.amount;
                        }
                    });
                }
                container.innerHTML = `
                    <div class="stat-card"><div class="label">S·ªë c√¥ng tr√¨nh</div><div class="value">${totalProjects}</div></div>
                    <div class="stat-card"><div class="label">T·ªïng ng√¢n s√°ch</div><div class="value">${formatMoney(totalBudget)}</div></div>
                    <div class="stat-card full-width"><div class="label">T·ªïng Thu</div><div class="value text-green">${formatMoney(totalThu)}</div></div>
                    <div class="stat-card full-width"><div class="label">T·ªïng Chi</div><div class="value text-red">${formatMoney(totalChi)}</div></div>
                    <div class="stat-card"><div class="label">Thu h√¥m nay</div><div class="value text-green">${formatMoney(todayThu)}</div></div>
                    <div class="stat-card"><div class="label">Chi h√¥m nay</div><div class="value text-red">${formatMoney(todayChi)}</div></div>
                    <div class="stat-card"><div class="label">Thu th√°ng n√†y</div><div class="value text-green">${formatMoney(monthThu)}</div></div>
                    <div class="stat-card"><div class="label">Chi th√°ng n√†y</div><div class="value text-red">${formatMoney(monthChi)}</div></div>
                `;
            } catch (error) {
                console.error(error);
                container.innerHTML = `<p class="status-message text-red full-width">L·ªói t·∫£i d·ªØ li·ªáu t·ªïng quan.</p>`;
            }
        }

        // --- PROJECTS LIST FUNCTIONS ---
        async function fetchProjects(populateSidePanel = false) {
            const container = document.getElementById('projects-container');
            if (!populateSidePanel) container.innerHTML = `<p class="status-message">ƒêang t·∫£i...</p>`;
            try {
                let query = db.collection('projects');
                if (currentUser.role !== 'admin') {
                    query = query.where('owner', '==', currentUser.uid);
                }
                const snapshot = await query.orderBy('createdAt', 'desc').get();
                if (snapshot.empty && !populateSidePanel) {
                    container.innerHTML = `<p class="status-message">B·∫°n ch∆∞a c√≥ c√¥ng tr√¨nh n√†o.</p>`; return;
                }
                let html = '', sidePanelHtml = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const canManage = canUserManageThisProject(p.owner);
                    const deleteButton = canManage ? `<button class="delete-button" onclick="deleteProject(event, '${doc.id}', '${p.name}')">üóëÔ∏è</button>` : '';
                    const ownerInfo = currentUser.role === 'admin' ? `<div class="project-owner">S·ªü h·ªØu: ${p.ownerDisplayName || p.ownerEmail || 'Kh√¥ng r√µ'}</div>` : '';
                    html += `
                        <div class="project-card">
                            ${deleteButton}
                            <h2>${p.name}</h2>
                            <p class="description">${p.description || ''}</p>
                            <div class="info-item"><span class="icon">üìç</span> ${p.address || 'Ch∆∞a c√≥ ƒë·ªãa ch·ªâ'}</div>
                            <div class="info-item"><span class="icon">üí∞</span> Ng√¢n s√°ch: <span style="color:var(--accent-blue);font-weight:700; margin-left: 5px;">${formatMoney(p.budget)}</span></div>
                            ${ownerInfo}
                            <button class="details-button" onclick="openProjectDetail('${doc.id}', '${p.name}')">Xem chi ti·∫øt & Thu/Chi</button>
                            ${canManage ? `<button class="details-button" style="background-color:#6c757d;margin-top:8px;" onclick="editProject('${doc.id}')">S·ª≠a c√¥ng tr√¨nh</button>` : ''}
                        </div>`;
                    sidePanelHtml += `<a href="#" onclick="switchProjectDetail('${doc.id}', '${p.name}')">${p.name}</a>`;
                });
                if (!populateSidePanel) container.innerHTML = html;
                document.getElementById('side-panel-project-list').innerHTML = sidePanelHtml;
            } catch (error) {
                console.error(error);
                container.innerHTML = `<p class="status-message text-red">L·ªói t·∫£i d·ªØ li·ªáu. ${error.message.includes('index') ? 'Vui l√≤ng t·∫°o ch·ªâ m·ª•c (index) trong Firestore.' : ''}</p>`;
            }
        }

        // --- PROJECT MANAGEMENT ---
        const pModal = document.getElementById('create-project-modal');
        let editingProjectId = null;
        document.getElementById('show-modal-btn').onclick = () => {
            editingProjectId = null;
            document.querySelector('#create-project-modal h2').textContent = 'C√¥ng tr√¨nh m·ªõi';
            document.getElementById('project-form').reset();
            pModal.classList.remove('hidden');
        };
        document.getElementById('cancel-p-btn').onclick = () => {
            pModal.classList.add('hidden');
            editingProjectId = null;
        };
        async function editProject(projectId) {
            if (!canUserManageProjects()) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a c√¥ng tr√¨nh');
                return;
            }
            editingProjectId = projectId;
            const doc = await db.collection('projects').doc(projectId).get();
            const p = doc.data();
            document.querySelector('#create-project-modal h2').textContent = 'S·ª≠a c√¥ng tr√¨nh';
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-desc').value = p.description || '';
            document.getElementById('p-address').value = p.address || '';
            document.getElementById('p-budget').value = new Intl.NumberFormat('vi-VN').format(p.budget);
            pModal.classList.remove('hidden');
        }
        document.getElementById('project-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!canUserManageProjects()) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y, LH : BTA');
                return;
            }
            try {
                const projectData = {
                    name: document.getElementById('p-name').value,
                    description: document.getElementById('p-desc').value,
                    address: document.getElementById('p-address').value,
                    budget: parseRawMoney(document.getElementById('p-budget').value)
                };
                if (editingProjectId) {
                    await db.collection('projects').doc(editingProjectId).update({
                        ...projectData,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await db.collection('projects').add({
                        ...projectData,
                        owner: currentUser.uid,
                        ownerEmail: currentUser.email,
                        ownerDisplayName: currentUser.displayName || null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                pModal.classList.add('hidden');
                e.target.reset();
                editingProjectId = null;
                fetchProjects();
            } catch (err) {
                alert('L·ªói: ' + err.message);
            }
        };
        async function deleteProject(e, id, name) {
            e.stopPropagation();
            if (!canUserManageProjects()) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a c√¥ng tr√¨nh');
                return;
            }
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¥ng tr√¨nh "${name}" v√† to√†n b·ªô d·ªØ li·ªáu thu chi li√™n quan kh√¥ng?`)) {
                await db.collection('projects').doc(id).delete();
                fetchProjects();
            }
        }

        // --- PROJECT DETAIL & TRANSACTIONS ---
        async function openProjectDetail(projectId, projectName) {
            currentProjectId = projectId;
            const doc = await db.collection('projects').doc(projectId).get();
            currentProjectData = doc.data();
            document.getElementById('detail-project-name').textContent = projectName;
            switchView('project-detail-view');
            loadTransactions();
            fetchProjects(true);
        }
        function switchProjectDetail(projectId, projectName) {
            if (currentProjectId !== projectId) {
                openProjectDetail(projectId, projectName);
            }
            toggleSidePanel();
        }
        let unsubscribeTransactions = null;
        function loadTransactions() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            const container = document.getElementById('transactions-container');
            container.innerHTML = `<p class="status-message">ƒêang t·∫£i giao d·ªãch...</p>`;
            const canManage = canUserManageTransactions() && 
                             (currentUser.role === 'admin' || currentProjectData.owner === currentUser.uid);
            unsubscribeTransactions = db.collection('projects').doc(currentProjectId).collection('transactions').orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    let thu = 0, chi = 0;
                    let html = snapshot.empty ? `<p class="status-message">Ch∆∞a c√≥ giao d·ªãch n√†o.</p>` : '';
                    snapshot.forEach(doc => {
                        const t = doc.data();
                        const isThu = t.type === 'thu';
                        const amount = t.amount || 0;
                        if (isThu) thu += amount; else chi += amount;
                        const actionButtons = canManage ? `
                            <button class="edit-btn" onclick="editTransaction('${doc.id}', '${t.type}', ${amount}, '${t.description.replace(/'/g, "\\'")}')">S·ª≠a</button>
                            <button class="delete-tx-btn" onclick="deleteTransaction('${doc.id}', '${t.description.replace(/'/g, "\\'")}')">X√≥a</button>
                        ` : '';
                        html += `
                            <div class="transaction-item">
                                <div class="t-info">
                                    <div class="t-desc">${t.description}</div>
                                    <div class="t-date">${formatDate(t.createdAt)}</div>
                                </div>
                                <div style="display:flex;align-items:center;">
                                    <div class="t-amount ${isThu ? 'text-green' : 'text-red'}">
                                        ${isThu ? '+' : '-'}${formatMoney(amount)}
                                    </div>
                                    ${actionButtons}
                                </div>
                            </div>`;
                    });
                    container.innerHTML = html;
                    document.getElementById('sum-thu').textContent = formatMoney(thu);
                    document.getElementById('sum-chi').textContent = formatMoney(chi);
                    document.getElementById('sum-balance').textContent = formatMoney(thu - chi);
                }, error => {
                    console.error("Tx Error:", error);
                    container.innerHTML = `<p class="status-message text-red">L·ªói t·∫£i giao d·ªãch.</p>`;
                });
        }
        function switchTransactionTab(type, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('thu-form-container').classList.toggle('hidden', type !== 'thu');
            document.getElementById('chi-form-container').classList.toggle('hidden', type !== 'chi');
            editingTransactionId = null;
            document.getElementById('transaction-form-thu').reset();
            document.getElementById('transaction-form-chi').reset();
            updateTransactionButtonText();
        }
        function updateTransactionButtonText() {
            const thuBtn = document.querySelector('#transaction-form-thu button[type="submit"]');
            const chiBtn = document.querySelector('#transaction-form-chi button[type="submit"]');
            const cancelThuBtn = document.getElementById('cancel-edit-thu-btn');
            const cancelChiBtn = document.getElementById('cancel-edit-chi-btn');
            if (editingTransactionId) {
                thuBtn.textContent = 'C·∫≠p nh·∫≠t Kho·∫£n Thu';
                chiBtn.textContent = 'C·∫≠p nh·∫≠t Kho·∫£n Chi';
                thuBtn.style.backgroundColor = '#f39c12';
                chiBtn.style.backgroundColor = '#f39c12';
                if (cancelThuBtn) cancelThuBtn.style.display = 'block';
                if (cancelChiBtn) cancelChiBtn.style.display = 'block';
            } else {
                thuBtn.textContent = 'Th√™m Kho·∫£n Thu';
                chiBtn.textContent = 'Th√™m Kho·∫£n Chi';
                thuBtn.style.backgroundColor = '';
                chiBtn.style.backgroundColor = '';
                if (cancelThuBtn) cancelThuBtn.style.display = 'none';
                if (cancelChiBtn) cancelChiBtn.style.display = 'none';
            }
        }
        function cancelEditTransaction(type) {
            editingTransactionId = null;
            if (type === 'thu') {
                document.getElementById('transaction-form-thu').reset();
            } else {
                document.getElementById('transaction-form-chi').reset();
            }
            updateTransactionButtonText();
        }
        function editTransaction(txId, type, amount, description) {
            if (!canUserManageTransactions()) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn s·ª≠a giao d·ªãch');
                return;
            }
            editingTransactionId = txId;
            const tabBtn = type === 'thu' ? 
                document.querySelector('.tab-btn:first-child') : 
                document.querySelector('.tab-btn:last-child');
            document.getElementById('transaction-form-thu').reset();
            document.getElementById('transaction-form-chi').reset();
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            tabBtn.classList.add('active');
            document.getElementById('thu-form-container').classList.toggle('hidden', type !== 'thu');
            document.getElementById('chi-form-container').classList.toggle('hidden', type !== 'chi');
            const formattedAmount = new Intl.NumberFormat('vi-VN').format(amount);
            if (type === 'thu') {
                document.getElementById('t-amount-thu').value = formattedAmount;
                document.getElementById('t-desc-thu').value = description;
            } else {
                document.getElementById('t-amount-chi').value = formattedAmount;
                document.getElementById('t-desc-chi').value = description;
            }
            updateTransactionButtonText();
            document.querySelector('.transaction-tabs').scrollIntoView({ behavior: 'smooth' });
        }
        async function deleteTransaction(txId, description) {
            if (!canUserManageTransactions()) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a giao d·ªãch');
                return;
            }
            if (confirm(`X√≥a giao d·ªãch "${description}"?`)) {
                await db.collection('projects').doc(currentProjectId).collection('transactions').doc(txId).delete();
                if (editingTransactionId === txId) {
                    editingTransactionId = null;
                    document.getElementById('transaction-form-thu').reset();
                    document.getElementById('transaction-form-chi').reset();
                    updateTransactionButtonText();
                }
            }
        }
        async function handleTransactionSubmit(type, amountElId, descElId, form) {
            if (!canUserManageTransactions()) {
                alert('B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y, LH : BTA');
                return;
            }
            const amountRaw = parseRawMoney(document.getElementById(amountElId).value);
            if (amountRaw <= 0) return alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá.');
            try {
                const txData = {
                    type: type,
                    amount: amountRaw,
                    description: document.getElementById(descElId).value
                };
                if (editingTransactionId) {
                    await db.collection('projects').doc(currentProjectId).collection('transactions')
                        .doc(editingTransactionId).update({
                            ...txData,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    editingTransactionId = null;
                } else {
                    await db.collection('projects').doc(currentProjectId).collection('transactions').add({
                        ...txData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                form.reset();
                updateTransactionButtonText();
            } catch (err) {
                alert('L·ªói thao t√°c giao d·ªãch: ' + err.message);
            }
        }
        document.getElementById('transaction-form-thu').onsubmit = (e) => {
            e.preventDefault();
            handleTransactionSubmit('thu', 't-amount-thu', 't-desc-thu', e.target);
        };
        document.getElementById('transaction-form-chi').onsubmit = (e) => {
            e.preventDefault();
            handleTransactionSubmit('chi', 't-amount-chi', 't-desc-chi', e.target);
        };

        // --- GLOBAL TRANSACTION SEARCH ---
        const searchAllTransactions = async (event) => {
            const searchTerm = event.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('search-results-container');
            if (!searchTerm) {
                resultsContainer.innerHTML = `
                    <p class="status-message">Li√™n h·ªá ng∆∞·ªùi l√†m ra app ƒë·ªÉ ƒëƒÉng k√Ω t√†i kho·∫£n (BTA)</p>
                    <div class="export-section">
                        <h3>Xu·∫•t d·ªØ li·ªáu & G·ª≠i email</h3>
                        <div class="form-group">
                            <label>Ch·ªçn c√¥ng tr√¨nh:</label>
                            <select id="export-project-select" class="form-input">
                                <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
                            </select>
                        </div>
                        <div class="export-buttons">
                            <button class="export-btn btn-pdf" onclick="exportPDF()">Xu·∫•t PDF</button>
                            <button class="export-btn btn-excel" onclick="exportExcel()">Xu·∫•t Excel</button>
                            <button class="export-btn btn-email" onclick="sendEmail()">G·ª≠i Email</button>
                        </div>
                    </div>
                `;
                setTimeout(() => populateProjectSelect(), 100);
                return;
            }
            resultsContainer.innerHTML = '<p class="status-message">ƒêang t√¨m ki·∫øm...</p>';
            try {
                let projectQuery = db.collection('projects');
                if (currentUser.role !== 'admin') {
                    projectQuery = projectQuery.where('owner', '==', currentUser.uid);
                }
                const projectSnap = await projectQuery.get();
                if (projectSnap.empty) {
                    resultsContainer.innerHTML = '<p class="status-message">Kh√¥ng c√≥ c√¥ng tr√¨nh n√†o ƒë·ªÉ t√¨m ki·∫øm.</p>';
                    return;
                }
                const transactionPromises = projectSnap.docs.map(pDoc => 
                    db.collection('projects').doc(pDoc.id).collection('transactions').get().then(txSnap => ({
                        projectId: pDoc.id,
                        projectName: pDoc.data().name,
                        transactions: txSnap.docs.map(txDoc => txDoc.data())
                    }))
                );
                const projectsWithTransactions = await Promise.all(transactionPromises);
                const allTransactions = [];
                projectsWithTransactions.forEach(project => {
                    project.transactions.forEach(tx => {
                        if (tx.description.toLowerCase().includes(searchTerm)) {
                            allTransactions.push({ ...tx, projectName: project.projectName, projectId: project.projectId });
                        }
                    });
                });
                if (allTransactions.length === 0) {
                    resultsContainer.innerHTML = '<p class="status-message">Kh√¥ng t√¨m th·∫•y giao d·ªãch n√†o ph√π h·ª£p.</p>';
                    return;
                }
                allTransactions.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                let html = '';
                allTransactions.forEach(t => {
                    const isThu = t.type === 'thu';
                    html += `
                        <div class="search-result-item" onclick="openProjectDetail('${t.projectId}', '${t.projectName}')">
                            <div class="info">
                                <div class="t-desc">${t.description}</div>
                                <div class="t-date">${formatDate(t.createdAt)}</div>
                                <div class="project-name">C√¥ng tr√¨nh: ${t.projectName}</div>
                            </div>
                            <div class="t-amount ${isThu ? 'text-green' : 'text-red'}">
                                ${isThu ? '+' : '-'}${formatMoney(t.amount)}
                            </div>
                        </div>`;
                });
                resultsContainer.innerHTML = html;
            } catch (error) {
                console.error("Search Error:", error);
                resultsContainer.innerHTML = '<p class="status-message text-red">ƒê√£ x·∫£y ra l·ªói khi t√¨m ki·∫øm.</p>';
            }
        };
        document.getElementById('transaction-search-input').addEventListener('input', debounce(searchAllTransactions, 500));

        // --- EXPORT & EMAIL FUNCTIONS ---
        async function populateProjectSelect() {
            const select = document.getElementById('export-project-select');
            if (!select) return;
            select.innerHTML = '<option value="">-- ƒêang t·∫£i... --</option>';
            try {
                let query = db.collection('projects');
                if (currentUser.role !== 'admin') {
                    query = query.where('owner', '==', currentUser.uid);
                }
                const snapshot = await query.orderBy('createdAt', 'desc').get();
                if (snapshot.empty) {
                    select.innerHTML = '<option value="">-- Kh√¥ng c√≥ c√¥ng tr√¨nh n√†o --</option>';
                    return;
                }
                let html = '<option value="">-- Ch·ªçn c√¥ng tr√¨nh --</option>';
                snapshot.forEach(doc => {
                    const name = doc.data().name || 'Kh√¥ng c√≥ t√™n';
                    html += `<option value="${doc.id}">${name}</option>`;
                });
                select.innerHTML = html;
            } catch (error) {
                console.error("Error loading projects:", error);
                select.innerHTML = '<option value="">-- L·ªói t·∫£i danh s√°ch --</option>';
            }
        }

        async function getProjectData(projectId) {
            const projectDoc = await db.collection('projects').doc(projectId).get();
            if (!projectDoc.exists) return null;
            const project = projectDoc.data();
            const txSnapshot = await db.collection('projects').doc(projectId).collection('transactions')
                .orderBy('createdAt', 'desc').get();
            const transactions = [];
            let totalThu = 0, totalChi = 0;
            txSnapshot.forEach(doc => {
                const tx = doc.data();
                transactions.push(tx);
                if (tx.type === 'thu') totalThu += tx.amount;
                else totalChi += tx.amount;
            });
            return {
                ...project,
                projectName: project.name,
                transactions,
                totalThu,
                totalChi,
                balance: totalThu - totalChi
            };
        }

        async function exportPDF() {
            const projectId = document.getElementById('export-project-select').value;
            if (!projectId) {
                alert('Vui l√≤ng ch·ªçn c√¥ng tr√¨nh');
                return;
            }
            const data = await getProjectData(projectId);
            if (!data) {
                alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c√¥ng tr√¨nh');
                return;
            }
            let html = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 20px; background: white; color: black; }
                        h1 { text-align: center; color: #2c3e50; }
                        .info { margin: 20px 0; }
                        .info-row { margin: 10px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #2c3e50; color: white; }
                        .thu { color: #2ecc71; }
                        .chi { color: #e74c3c; }
                        .summary { margin-top: 20px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <h1>B√ÅO C√ÅO C√îNG TR√åNH</h1>
                    <div class="info">
                        <div class="info-row"><strong>T√™n c√¥ng tr√¨nh:</strong> ${data.projectName}</div>
                        <div class="info-row"><strong>M√¥ t·∫£:</strong> ${data.description || 'Kh√¥ng c√≥'}</div>
                        <div class="info-row"><strong>ƒê·ªãa ch·ªâ:</strong> ${data.address || 'Kh√¥ng c√≥'}</div>
                        <div class="info-row"><strong>Ng√¢n s√°ch:</strong> ${formatMoney(data.budget)}</div>
                    </div>
                    <h2>L·ªäCH S·ª¨ GIAO D·ªäCH</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Ng√†y</th>
                                <th>M√¥ t·∫£</th>
                                <th>Lo·∫°i</th>
                                <th>S·ªë ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>`;
            data.transactions.forEach(tx => {
                html += `
                    <tr>
                        <td>${formatDate(tx.createdAt)}</td>
                        <td>${tx.description}</td>
                        <td class="${tx.type}">${tx.type === 'thu' ? 'Thu' : 'Chi'}</td>
                        <td class="${tx.type}">${formatMoney(tx.amount)}</td>
                    </tr>`;
            });
            html += `
</tbody>
                    </table>
                    <div class="summary">
                        <div>T·ªïng Thu: <span class="thu">${formatMoney(data.totalThu)}</span></div>
                        <div>T·ªïng Chi: <span class="chi">${formatMoney(data.totalChi)}</span></div>
                        <div>S·ªë d∆∞: ${formatMoney(data.balance)}</div>
                    </div>
                </body>
                </html>`;
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        async function exportExcel() {
            const projectId = document.getElementById('export-project-select').value;
            if (!projectId) {
                alert('Vui l√≤ng ch·ªçn c√¥ng tr√¨nh');
                return;
            }
            const data = await getProjectData(projectId);
            if (!data) {
                alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c√¥ng tr√¨nh');
                return;
            }
            let csv = '\uFEFF';
            csv += `B√ÅO C√ÅO C√îNG TR√åNH\n`;
            csv += `T√™n c√¥ng tr√¨nh:,${data.projectName}\n`;
            csv += `M√¥ t·∫£:,${data.description || 'Kh√¥ng c√≥'}\n`;
            csv += `ƒê·ªãa ch·ªâ:,${data.address || 'Kh√¥ng c√≥'}\n`;
            csv += `Ng√¢n s√°ch:,${data.budget}\n`;
            csv += `Ng√†y,M√¥ t·∫£,Lo·∫°i,S·ªë ti·ªÅn\n`;
            data.transactions.forEach(tx => {
                csv += `${formatDate(tx.createdAt)},"${tx.description}",${tx.type === 'thu' ? 'Thu' : 'Chi'},${tx.amount}\n`;
            });
            csv += `\nT·ªïng Thu:,,,${data.totalThu}\n`;
            csv += `T·ªïng Chi:,,,${data.totalChi}\n`;
            csv += `S·ªë d∆∞:,,,${data.balance}\n`;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${data.projectName}_${new Date().getTime()}.csv`;
            link.click();
        }

        async function sendEmail() {
            const projectId = document.getElementById('export-project-select').value;
            if (!projectId) {
                alert('Vui l√≤ng ch·ªçn c√¥ng tr√¨nh');
                return;
            }
            const email = prompt('Nh·∫≠p ƒë·ªãa ch·ªâ email nh·∫≠n:');
            if (!email || !email.includes('@')) {
                alert('Email kh√¥ng h·ª£p l·ªá');
                return;
            }
            const data = await getProjectData(projectId);
            if (!data) {
                alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu c√¥ng tr√¨nh');
                return;
            }
            let emailBody = `B√ÅO C√ÅO C√îNG TR√åNH: ${data.projectName}\n`;
            emailBody += `M√¥ t·∫£: ${data.description || 'Kh√¥ng c√≥'}\n`;
            emailBody += `ƒê·ªãa ch·ªâ: ${data.address || 'Kh√¥ng c√≥'}\n`;
            emailBody += `Ng√¢n s√°ch: ${formatMoney(data.budget)}\n`;
            emailBody += `T·ªîNG QUAN:\n`;
            emailBody += `- T·ªïng Thu: ${formatMoney(data.totalThu)}\n`;
            emailBody += `- T·ªïng Chi: ${formatMoney(data.totalChi)}\n`;
            emailBody += `- S·ªë d∆∞: ${formatMoney(data.balance)}\n`;
            emailBody += `GIAO D·ªäCH:\n`;
            data.transactions.forEach((tx, index) => {
                emailBody += `${index + 1}. ${formatDate(tx.createdAt)} - ${tx.description} - ${tx.type === 'thu' ? 'Thu' : 'Chi'}: ${formatMoney(tx.amount)}\n`;
            });
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent('B√°o c√°o c√¥ng tr√¨nh: ' + data.projectName)}&body=${encodeURIComponent(emailBody)}`;
            if (mailtoLink.length > 2000) {
                alert('D·ªØ li·ªáu qu√° d√†i. Vui l√≤ng s·ª≠ d·ª•ng ch·ª©c nƒÉng xu·∫•t PDF ho·∫∑c Excel r·ªìi g·ª≠i file ƒë√≠nh k√®m.');
            } else {
                window.location.href = mailtoLink;
            }
        }

        // --- SIDE PANEL ---
        function toggleSidePanel() {
            document.getElementById('project-side-panel').classList.toggle('open');
            document.getElementById('side-panel-backdrop').classList.toggle('hidden');
        }

        // --- ADMIN FUNCTIONS ---
        async function loadAdminUsers() {
            if (currentUser.role !== 'admin') return;
            const container = document.getElementById('users-container');
            const snap = await db.collection('users').get();
            let html = '';
            snap.forEach(doc => {
                const u = doc.data();
                const uId = doc.id;
                if (uId === currentUser.uid) return;
                const canManageProjects = u.canManageProjects === true;
                const canManageTransactions = u.canManageTransactions === true;
                html += `<div class="user-card">
                    <div class="user-details">
                        <div class="display-name">${u.displayName || '(Ch∆∞a ƒë·∫∑t t√™n)'}</div>
                        <div class="email">${u.email}</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-set-name" onclick="setDisplayName('${uId}')">ƒê·∫∑t t√™n</button>
                        <div class="permission-group">
                            <div class="permission-item">
                                <span class="toggle-label">Qu·∫£n l√Ω c√¥ng tr√¨nh</span>
                                <label class="switch">
                                    <input type="checkbox" ${canManageProjects ? 'checked' : ''} 
                                        onchange="togglePermission('${uId}', 'canManageProjects', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="permission-item">
                                <span class="toggle-label">Qu·∫£n l√Ω thu chi</span>
                                <label class="switch">
                                    <input type="checkbox" ${canManageTransactions ? 'checked' : ''} 
                                        onchange="togglePermission('${uId}', 'canManageTransactions', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html || '<p>Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o kh√°c.</p>';
        }

        async function setDisplayName(userId) {
            const currentName = await db.collection('users').doc(userId).get().then(doc => doc.data().displayName || '');
            const newName = prompt("Nh·∫≠p t√™n hi·ªÉn th·ªã m·ªõi cho ng∆∞·ªùi d√πng:", currentName);
            if (newName !== null) {
                await db.collection('users').doc(userId).update({ displayName: newName.trim() });
                loadAdminUsers();
            }
        }

        async function togglePermission(userId, permissionField, value) {
            if (currentUser.role !== 'admin') return;
            try {
                await db.collection('users').doc(userId).update({ [permissionField]: value });
            } catch (err) {
                alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t quy·ªÅn. Vui l√≤ng th·ª≠ l·∫°i.");
                loadAdminUsers();
            }
        }

        document.getElementById('logout-btn').onclick = () => auth.signOut();

        // Initialize export section on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                const searchInput = document.getElementById('transaction-search-input');
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.dispatchEvent(new Event('input'));
                }
            }, 500);
        });
    </script>
</body>
</html>