<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Công trình</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Styles --- */
        :root {
            --primary-blue: #2563eb;
            --primary-blue-dark: #1d4ed8;
            --success-green: #22c55e;
            --danger-red: #ef4444;
            --light-gray: #f3f4f6;
            --text-dark: #1f2937;
            --text-secondary: #6b7280;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .hidden { display: none !important; }
        body { margin: 0; font-family: 'Be Vietnam Pro', sans-serif; background-color: var(--light-gray); color: var(--text-dark); line-height: 1.6; }
        .container { padding: 20px; padding-bottom: 100px; max-width: 800px; margin: 0 auto; }
        .page-header { font-size: 32px; font-weight: 700; margin: 0 0 28px 0; display: flex; align-items: center; }
        .welcome-header { font-size: 20px; font-weight: 500; color: var(--text-secondary); margin-bottom: 24px; }
        .back-button, .hamburger-btn { background: none; border: none; font-size: 28px; margin-right: 12px; cursor: pointer; color: var(--text-dark); }
        .status-message { text-align: center; color: var(--text-secondary); padding: 50px 0; }
        .text-green { color: var(--success-green); }
        .text-red { color: var(--danger-red); }

        /* --- Animations --- */
        .view { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Views --- */
        .view.active { display: block; }
        .view { display: none; }

        /* --- Overview View --- */
        .overview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .stat-card { background-color: var(--white); padding: 20px; border-radius: 12px; box-shadow: var(--shadow-sm); }
        .stat-card .label { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .stat-card .value { font-size: 24px; font-weight: 700; }
        .stat-card.full-width { grid-column: 1 / -1; }

        /* --- Project List View --- */
        .create-button { display: flex; align-items: center; justify-content: center; width: 100%; padding: 18px; margin-bottom: 28px; font-size: 18px; font-weight: 700; color: var(--white); background-image: linear-gradient(to right, var(--primary-blue), #3b82f6); border: none; border-radius: 12px; cursor: pointer; box-shadow: var(--shadow-md); transition: all 0.2s ease; }
        .create-button:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .project-card { background-color: var(--white); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-md); position: relative; margin-bottom: 24px; transition: all 0.2s ease-in-out; border: 1px solid #e5e7eb; }
        .project-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .project-card h2 { margin: 0 0 4px 0; font-size: 22px; font-weight: 700; padding-right: 30px; }
        .project-card .description { color: var(--text-secondary); margin-bottom: 12px; font-size: 15px; }
        .project-card .info-item { color: var(--text-secondary); margin-bottom: 12px; font-size: 15px; display: flex; align-items: center; }
        .project-card .info-item .icon { margin-right: 8px; font-size: 18px; }
        .project-card .details-button { width: 100%; padding: 14px; margin-top: 16px; border: none; background-color: var(--primary-blue); color: var(--white); border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        .project-card .details-button:hover { background-color: var(--primary-blue-dark); }
        .project-card .delete-button { position: absolute; top: 20px; right: 20px; background: none; border: none; cursor: pointer; color: var(--danger-red); font-size: 22px; z-index: 2; opacity: 0.7; transition: opacity 0.2s; }
        .project-card .delete-button:hover { opacity: 1; }
        .project-owner { font-size: 12px; background-color: #eef2ff; color: #4338ca; padding: 4px 10px; border-radius: 99px; font-weight: 500; margin-top: 16px; display: inline-block; }

        /* --- Project Detail View --- */
        .finance-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .finance-card { background: var(--white); padding: 16px 12px; border-radius: 12px; text-align: center; box-shadow: var(--shadow-sm); }
        .finance-card .label { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .finance-card .value { font-weight: 700; font-size: 16px; }
        .finance-balance-card { grid-column: 1 / -1; margin-bottom: 28px; }
        .finance-balance-card .value { font-size: 22px; }

        .transaction-tabs { display: flex; margin-bottom: 16px; border-bottom: 1px solid #e5e7eb; }
        .tab-btn { flex: 1; padding: 14px; font-size: 16px; font-weight: 500; text-align: center; background: none; border: none; cursor: pointer; color: var(--text-secondary); border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }
        .add-transaction-form { background: var(--white); padding: 20px; border-radius: 16px; margin-bottom: 28px; box-shadow: var(--shadow-md); }
        .form-row { margin-bottom: 16px; }
        .form-input { padding: 16px; border-radius: 10px; border: 1px solid #d1d5db; font-family: inherit; font-size: 16px; width: 100%; box-sizing: border-box; }
        .add-btn { background-color: var(--primary-blue); color: white; border: none; cursor: pointer; width: 100%; padding: 18px; font-size: 18px; font-weight: 700; border-radius: 10px; transition: background-color 0.2s; }
        .add-btn:hover { background-color: var(--primary-blue-dark); }
        .transaction-list h3 { margin-bottom: 12px; font-size: 20px; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 16px; border-bottom: 1px solid #f3f4f6; }
        .transaction-item:first-of-type { border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .transaction-item:last-of-type { border-bottom: none; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .t-info .t-desc { font-weight: 500; margin-bottom: 4px; font-size: 16px; }
        .t-info .t-date { font-size: 13px; color: var(--text-secondary); }
        .t-amount { font-weight: 700; font-size: 16px; }

        /* --- Admin View --- */
        .admin-section h2 { font-size: 22px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; margin-bottom: 16px; }
        .user-card { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background-color: var(--white); padding: 16px; border-radius: 10px; margin-bottom: 12px; box-shadow: var(--shadow-sm); gap: 10px; }
        .user-details { flex: 1 1 200px; }
        .user-details .display-name { font-weight: 700; font-size: 16px; }
        .user-details .email { font-size: 14px; color: var(--text-secondary); }
        .user-actions { display: flex; align-items: center; gap: 16px; }
        .btn-set-name { background-color: #eef2ff; color: #4338ca; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        .btn-set-name:hover { background-color: #e0e7ff; }
        .permission-toggle { display: flex; flex-direction: column; align-items: center; }
        .permission-toggle .toggle-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-green); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- Modals, Navs, Side Panel --- */
        .modal-backdrop, .side-panel-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 100; animation: fadeIn 0.3s; }
        .modal-backdrop { display: flex; align-items: center; justify-content: center; }
        .modal { background: #fff; border-radius: 16px; padding: 28px; width: 90%; max-width: 450px; z-index: 101; box-shadow: var(--shadow-lg); }
        .modal h2 { margin-top: 0; font-size: 24px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
        .modal button { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s; }
        .btn-save { background-color: var(--primary-blue); color: #fff; }
        .btn-save:hover { background-color: var(--primary-blue-dark); }
        .btn-cancel { background-color: #e5e7eb; }
        .btn-cancel:hover { background-color: #d1d5db; }
        
        .side-panel { position: fixed; top: 0; left: 0; width: 80%; max-width: 300px; height: 100%; background-color: var(--white); z-index: 110; box-shadow: var(--shadow-lg); transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .side-panel.open { transform: translateX(0); }
        .side-panel-header { padding: 20px; font-size: 20px; font-weight: 700; border-bottom: 1px solid #e5e7eb; }
        .side-panel-list a { display: block; padding: 15px 20px; text-decoration: none; color: var(--text-dark); border-bottom: 1px solid #f3f4f6; }
        .side-panel-list a:hover { background-color: var(--light-gray); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background-color: var(--white); border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08); z-index: 90; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-secondary); font-size: 12px; font-weight: 500; border: none; background: none; cursor: pointer; padding: 0 10px; transition: color 0.2s; }
        .nav-item .icon { font-size: 28px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-blue); }
    </style>
</head>
<body>
    <main class="container">
        <div id="welcome-message" class="welcome-header"></div>

        <!-- VIEW 1: OVERVIEW -->
        <div id="overview-view" class="view">
            <h1 class="page-header">Tổng quan</h1>
            <div id="overview-container" class="overview-grid">
                <p class="status-message full-width">Đang tải dữ liệu tổng quan...</p>
            </div>
        </div>

        <!-- VIEW 2: PROJECTS LIST -->
        <div id="projects-view" class="view active">
            <h1 class="page-header">Công trình</h1>
            <button class="create-button" id="show-modal-btn"><span class="plus-icon">+</span> Tạo công trình mới</button>
            <div id="projects-container"><p class="status-message">Đang tải...</p></div>
        </div>

        <!-- VIEW 3: PROJECT DETAIL (THU/CHI) -->
        <div id="project-detail-view" class="view">
            <header class="page-header">
                <button class="hamburger-btn" onclick="toggleSidePanel()">☰</button>
                <button class="back-button" onclick="goBackToProjects()">←</button>
                <span id="detail-project-name">Tên công trình</span>
            </header>
             <div class="finance-summary">
                <div class="finance-card"><div class="label">Tổng Thu</div><div class="value text-green" id="sum-thu">0 đ</div></div>
                <div class="finance-card"><div class="label">Tổng Chi</div><div class="value text-red" id="sum-chi">0 đ</div></div>
            </div>
            <div class="finance-card finance-balance-card">
                <div class="label">Số dư</div>
                <div class="value" id="sum-balance">0 đ</div>
            </div>

            <div class="transaction-tabs">
                <button class="tab-btn active" onclick="switchTransactionTab('thu', this)">Thêm Khoản Thu</button>
                <button class="tab-btn" onclick="switchTransactionTab('chi', this)">Thêm Khoản Chi</button>
            </div>

            <div id="thu-form-container" class="add-transaction-form">
                <form id="transaction-form-thu">
                    <div class="form-row"><input type="text" id="t-amount-thu" class="form-input" placeholder="Số tiền Thu (VNĐ)" required oninput="formatInputMoney(this)"></div>
                    <div class="form-row"><input type="text" id="t-desc-thu" class="form-input" placeholder="Mô tả (VD: Chủ nhà ứng tiền)" required></div>
                    <button type="submit" class="add-btn">Thêm Khoản Thu</button>
                </form>
            </div>
            <div id="chi-form-container" class="add-transaction-form hidden">
                 <form id="transaction-form-chi">
                    <div class="form-row"><input type="text" id="t-amount-chi" class="form-input" placeholder="Số tiền Chi (VNĐ)" required oninput="formatInputMoney(this)"></div>
                    <div class="form-row"><input type="text" id="t-desc-chi" class="form-input" placeholder="Mô tả (VD: Mua vật tư, Trả lương)" required></div>
                    <button type="submit" class="add-btn">Thêm Khoản Chi</button>
                </form>
            </div>

            <div class="transaction-list">
                <h3>Lịch sử giao dịch</h3>
                <div id="transactions-container"><p class="status-message">Chưa có giao dịch nào.</p></div>
            </div>
        </div>

        <!-- VIEW 4: ADMIN -->
        <div id="admin-view" class="view">
            <h1 class="page-header">Quản trị viên</h1>
            <div class="admin-section">
                <h2>Quản lý người dùng</h2>
                <div id="users-container"><p class="status-message">Đang tải...</p></div>
            </div>
        </div>
    </main>

    <!-- CREATE PROJECT MODAL -->
    <div id="create-project-modal" class="modal-backdrop hidden">
        <div class="modal">
            <h2>Công trình mới</h2>
            <form id="project-form">
                <div class="form-group"><label>Tên công trình *</label><input type="text" id="p-name" required></div>
                <div class="form-group"><label>Mô tả</label><textarea id="p-desc" rows="2"></textarea></div>
                <div class="form-group"><label>Địa chỉ</label><input type="text" id="p-address"></div>
                <div class="form-group"><label>Ngân sách dự kiến *</label><input type="text" id="p-budget" required oninput="formatInputMoney(this)"></div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="cancel-p-btn">Hủy</button>
                    <button type="submit" class="btn-save">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- HAMBURGER SIDE PANEL -->
    <div id="side-panel-backdrop" class="side-panel-backdrop hidden" onclick="toggleSidePanel()"></div>
    <div id="project-side-panel" class="side-panel">
        <div class="side-panel-header">Chuyển công trình</div>
        <div id="side-panel-project-list" class="side-panel-list"></div>
    </div>

    <nav class="bottom-nav" id="main-nav">
        <button class="nav-item" data-view="overview-view"><span class="icon">🏠</span><span>Tổng quan</span></button>
        <button class="nav-item active" data-view="projects-view"><span class="icon">📁</span><span>Công trình</span></button>
        <button class="nav-item hidden" id="admin-nav-btn" data-view="admin-view"><span class="icon">🛡️</span><span>Admin</span></button>
        <button class="nav-item" id="logout-btn"><span class="icon">🚪</span><span>Đăng xuất</span></button>
    </nav>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyBKfEhKahWesUl_JV6mlSWmaKW2LSkKqos",
            authDomain: "quanlycongtrinh-ab20c.firebaseapp.com",
            projectId: "quanlycongtrinh-ab20c",
            storageBucket: "quanlycongtrinh-ab20c.firebasestorage.app",
            messagingSenderId: "465625666899",
            appId: "1:465625666899:web:e67ccdfdbc9dc85ad7fda6"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let currentProjectId = null;

        // --- AUTH STATE LISTENER ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.uid).get();
                currentUser = userDoc.exists ? { uid: user.uid, ...userDoc.data() } : { uid: user.uid, email: user.email, role: 'user', canCreateProjects: true };
                document.getElementById('welcome-message').textContent = `Xin chào, ${currentUser.displayName || currentUser.email}!`;
                document.getElementById('admin-nav-btn').classList.toggle('hidden', currentUser.role !== 'admin');
                const createBtn = document.getElementById('show-modal-btn');
                const canCreate = currentUser.role === 'admin' || currentUser.canCreateProjects;
                createBtn.classList.toggle('hidden', !canCreate);
                document.querySelector('.nav-item[data-view="projects-view"]').click();
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- NAVIGATION LOGIC ---
        const navItems = document.querySelectorAll('.nav-item[data-view]');
        const views = document.querySelectorAll('.view');
        const bottomNav = document.getElementById('main-nav');

        function switchView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            bottomNav.classList.toggle('hidden', viewId === 'project-detail-view');
            if (viewId !== 'project-detail-view') {
                navItems.forEach(nav => nav.classList.toggle('active', nav.getAttribute('data-view') === viewId));
            }
        }

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const viewId = item.getAttribute('data-view');
                switchView(viewId);
                if (viewId === 'overview-view') fetchOverviewData();
                if (viewId === 'projects-view') fetchProjects();
                if (viewId === 'admin-view') loadAdminUsers();
            });
        });

        function goBackToProjects() {
            currentProjectId = null;
            switchView('projects-view');
            fetchProjects();
        }

        // --- UTILS ---
        const formatMoney = (num) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num);
        function formatInputMoney(input) {
            let value = input.value.replace(/\D/g, '');
            input.value = value ? new Intl.NumberFormat('vi-VN').format(value) : '';
        }
        function parseRawMoney(formattedValue) { return parseInt(String(formattedValue).replace(/\D/g, '')) || 0; }
        const formatDate = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        };

        // --- OVERVIEW FUNCTIONS ---
        async function fetchOverviewData() {
            const container = document.getElementById('overview-container');
            container.innerHTML = `<p class="status-message full-width">Đang tải dữ liệu...</p>`;
            try {
                let projectQuery = db.collection('projects');
                if (currentUser.role !== 'admin') {
                    projectQuery = projectQuery.where('owner', '==', currentUser.uid);
                }
                const projectSnap = await projectQuery.get();
                
                let totalProjects = 0;
                let totalBudget = 0;
                let totalThu = 0;
                let totalChi = 0;
                let todayThu = 0;
                let todayChi = 0;
                let monthThu = 0;
                let monthChi = 0;

                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const monthStart = new Date(todayStart.getFullYear(), todayStart.getMonth(), 1);

                for (const doc of projectSnap.docs) {
                    totalProjects++;
                    totalBudget += doc.data().budget || 0;
                    const txSnap = await db.collection('projects').doc(doc.id).collection('transactions').get();
                    txSnap.forEach(txDoc => {
                        const tx = txDoc.data();
                        const txDate = tx.createdAt.toDate();
                        if (tx.type === 'thu') {
                            totalThu += tx.amount;
                            if (txDate >= todayStart) todayThu += tx.amount;
                            if (txDate >= monthStart) monthThu += tx.amount;
                        } else {
                            totalChi += tx.amount;
                            if (txDate >= todayStart) todayChi += tx.amount;
                            if (txDate >= monthStart) monthChi += tx.amount;
                        }
                    });
                }

                container.innerHTML = `
                    <div class="stat-card"><div class="label">Số công trình</div><div class="value">${totalProjects}</div></div>
                    <div class="stat-card"><div class="label">Tổng ngân sách</div><div class="value">${formatMoney(totalBudget)}</div></div>
                    <div class="stat-card full-width"><div class="label">Tổng Thu</div><div class="value text-green">${formatMoney(totalThu)}</div></div>
                    <div class="stat-card full-width"><div class="label">Tổng Chi</div><div class="value text-red">${formatMoney(totalChi)}</div></div>
                    <div class="stat-card"><div class="label">Thu hôm nay</div><div class="value text-green">${formatMoney(todayThu)}</div></div>
                    <div class="stat-card"><div class="label">Chi hôm nay</div><div class="value text-red">${formatMoney(todayChi)}</div></div>
                    <div class="stat-card"><div class="label">Thu tháng này</div><div class="value text-green">${formatMoney(monthThu)}</div></div>
                    <div class="stat-card"><div class="label">Chi tháng này</div><div class="value text-red">${formatMoney(monthChi)}</div></div>
                `;
            } catch (error) {
                console.error(error);
                container.innerHTML = `<p class="status-message text-red full-width">Lỗi tải dữ liệu tổng quan.</p>`;
            }
        }

        // --- PROJECTS LIST FUNCTIONS ---
        async function fetchProjects(populateSidePanel = false) {
            const container = document.getElementById('projects-container');
            if (!populateSidePanel) container.innerHTML = `<p class="status-message">Đang tải...</p>`;
            try {
                let query = db.collection('projects');
                if (currentUser.role !== 'admin') {
                    query = query.where('owner', '==', currentUser.uid);
                }
                const snapshot = await query.orderBy('createdAt', 'desc').get();
                
                if (snapshot.empty && !populateSidePanel) {
                    container.innerHTML = `<p class="status-message">Bạn chưa có công trình nào.</p>`; return;
                }
                
                let html = '';
                let sidePanelHtml = '';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    const canDelete = currentUser.role === 'admin' || p.owner === currentUser.uid;
                    const deleteButton = canDelete ? `<button class="delete-button" onclick="deleteProject(event, '${doc.id}', '${p.name}')">🗑️</button>` : '';
                    const ownerInfo = currentUser.role === 'admin' ? `<div class="project-owner">Sở hữu: ${p.ownerDisplayName || p.ownerEmail || 'Không rõ'}</div>` : '';

                    html += `
                        <div class="project-card">
                            ${deleteButton}
                            <h2>${p.name}</h2>
                            <p class="description">${p.description || ''}</p>
                            <div class="info-item"><span class="icon">📍</span> ${p.address || 'Chưa có địa chỉ'}</div>
                            <div class="info-item"><span class="icon">💰</span> Ngân sách: <span style="color:var(--primary-blue);font-weight:700; margin-left: 5px;">${formatMoney(p.budget)}</span></div>
                            ${ownerInfo}
                            <button class="details-button" onclick="openProjectDetail('${doc.id}', '${p.name}')">Xem chi tiết & Thu/Chi</button>
                        </div>`;
                    
                    sidePanelHtml += `<a href="#" onclick="switchProjectDetail('${doc.id}', '${p.name}')">${p.name}</a>`;
                });

                if (!populateSidePanel) container.innerHTML = html;
                document.getElementById('side-panel-project-list').innerHTML = sidePanelHtml;
            } catch (error) {
                console.error(error);
                container.innerHTML = `<p class="status-message text-red">Lỗi tải dữ liệu. ${error.message.includes('index') ? 'Vui lòng tạo chỉ mục (index) trong Firestore.' : ''}</p>`;
            }
        }

        // --- PROJECT MANAGEMENT ---
        const pModal = document.getElementById('create-project-modal');
        document.getElementById('show-modal-btn').onclick = () => pModal.classList.remove('hidden');
        document.getElementById('cancel-p-btn').onclick = () => pModal.classList.add('hidden');
        document.getElementById('project-form').onsubmit = async (e) => {
            e.preventDefault();
            try {
                await db.collection('projects').add({
                    name: document.getElementById('p-name').value,
                    description: document.getElementById('p-desc').value,
                    address: document.getElementById('p-address').value,
                    budget: parseRawMoney(document.getElementById('p-budget').value),
                    owner: currentUser.uid,
                    ownerEmail: currentUser.email,
                    ownerDisplayName: currentUser.displayName || null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                pModal.classList.add('hidden'); e.target.reset();
                fetchProjects();
            } catch (err) { alert('Lỗi: ' + err.message); }
        };

        async function deleteProject(e, id, name) {
            e.stopPropagation();
            if (confirm(`Bạn có chắc muốn xóa công trình "${name}" và toàn bộ dữ liệu thu chi liên quan không?`)) {
                await db.collection('projects').doc(id).delete();
                fetchProjects();
            }
        }

        // --- PROJECT DETAIL & TRANSACTIONS ---
        async function openProjectDetail(projectId, projectName) {
            currentProjectId = projectId;
            document.getElementById('detail-project-name').textContent = projectName;
            switchView('project-detail-view');
            loadTransactions();
            fetchProjects(true); // Populate side panel
        }
        
        function switchProjectDetail(projectId, projectName) {
             if (currentProjectId !== projectId) {
                openProjectDetail(projectId, projectName);
            }
            toggleSidePanel();
        }

        let unsubscribeTransactions = null;
        function loadTransactions() {
            if (unsubscribeTransactions) unsubscribeTransactions();
            const container = document.getElementById('transactions-container');
            container.innerHTML = `<p class="status-message">Đang tải giao dịch...</p>`;
            unsubscribeTransactions = db.collection('projects').doc(currentProjectId).collection('transactions').orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    let thu = 0, chi = 0;
                    let html = snapshot.empty ? `<p class="status-message">Chưa có giao dịch nào.</p>` : '';
                    snapshot.forEach(doc => {
                        const t = doc.data();
                        const isThu = t.type === 'thu';
                        const amount = t.amount || 0;
                        if (isThu) thu += amount; else chi += amount;
                        html += `
                            <div class="transaction-item">
                                <div class="t-info">
                                    <div class="t-desc">${t.description}</div>
                                    <div class="t-date">${formatDate(t.createdAt)}</div>
                                </div>
                                <div class="t-amount ${isThu ? 'text-green' : 'text-red'}">
                                    ${isThu ? '+' : '-'}${formatMoney(amount)}
                                </div>
                            </div>`;
                    });
                    container.innerHTML = html;
                    document.getElementById('sum-thu').textContent = formatMoney(thu);
                    document.getElementById('sum-chi').textContent = formatMoney(chi);
                    document.getElementById('sum-balance').textContent = formatMoney(thu - chi);
                }, error => {
                    console.error("Tx Error:", error);
                    container.innerHTML = `<p class="status-message text-red">Lỗi tải giao dịch.</p>`;
                });
        }

        function switchTransactionTab(type, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('thu-form-container').classList.toggle('hidden', type !== 'thu');
            document.getElementById('chi-form-container').classList.toggle('hidden', type !== 'chi');
        }
        
        async function handleTransactionSubmit(type, amountElId, descElId, form) {
            const amountRaw = parseRawMoney(document.getElementById(amountElId).value);
            if (amountRaw <= 0) return alert('Vui lòng nhập số tiền hợp lệ.');
            try {
                await db.collection('projects').doc(currentProjectId).collection('transactions').add({
                    type: type,
                    amount: amountRaw,
                    description: document.getElementById(descElId).value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                form.reset();
            } catch (err) { alert('Lỗi thêm giao dịch: ' + err.message); }
        }
        document.getElementById('transaction-form-thu').onsubmit = (e) => {
            e.preventDefault();
            handleTransactionSubmit('thu', 't-amount-thu', 't-desc-thu', e.target);
        };
        document.getElementById('transaction-form-chi').onsubmit = (e) => {
            e.preventDefault();
            handleTransactionSubmit('chi', 't-amount-chi', 't-desc-chi', e.target);
        };

        // --- SIDE PANEL ---
        function toggleSidePanel() {
            document.getElementById('project-side-panel').classList.toggle('open');
            document.getElementById('side-panel-backdrop').classList.toggle('hidden');
        }

        // --- ADMIN FUNCTIONS ---
        async function loadAdminUsers() {
            if (currentUser.role !== 'admin') return;
            const container = document.getElementById('users-container');
            const snap = await db.collection('users').get();
            let html = '';
            snap.forEach(doc => {
                const u = doc.data();
                const uId = doc.id;
                if (uId === currentUser.uid) return;
                const canCreate = u.canCreateProjects !== false;
                html += `<div class="user-card">
                    <div class="user-details">
                        <div class="display-name">${u.displayName || '(Chưa đặt tên)'}</div>
                        <div class="email">${u.email}</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-set-name" onclick="setDisplayName('${uId}')">Đặt tên</button>
                        <div class="permission-toggle">
                            <span class="toggle-label">Cấp quyền</span>
                            <label class="switch">
                                <input type="checkbox" ${canCreate ? 'checked' : ''} onchange="toggleCreatePermission('${uId}', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html || '<p>Không có người dùng nào khác.</p>';
        }
        async function setDisplayName(userId) {
            const currentName = await db.collection('users').doc(userId).get().then(doc => doc.data().displayName || '');
            const newName = prompt("Nhập tên hiển thị mới cho người dùng:", currentName);
            if (newName !== null) {
                await db.collection('users').doc(userId).update({ displayName: newName.trim() });
                loadAdminUsers();
            }
        }
        async function toggleCreatePermission(userId, canCreate) {
             if (currentUser.role !== 'admin') return;
             await db.collection('users').doc(userId).update({ canCreateProjects: canCreate }).catch(err => {
                alert("Không thể cập nhật quyền. Vui lòng thử lại.");
                loadAdminUsers();
             });
        }
        document.getElementById('logout-btn').onclick = () => auth.signOut();
    </script>
</body>
</html>